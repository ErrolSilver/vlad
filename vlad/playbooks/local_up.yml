---
- hosts: all
  gather_facts: false
  vars_files:
    - "./vars/defaults/vagrant.yml"
    - "./vars/defaults/general.yml"
    - [ "../../../settings/vlad-settings.yml", "../settings.yml", "../example.settings.yml" ]

  tasks:

  - name: local actions | check local ip address is defined
    fail: msg="The system may not be provisioned according to the CMDB status."
    when: local_ip_address is not defined

  - name: local actions | write local host.ini file
    template: src=templates/host.j2 dest=../host.ini
    delegate_to: 127.0.0.1

  - name: local actions | remove reference of host from local hosts file
    lineinfile:
        dest='{{ hosts_file_location }}'
        state=absent
        regexp='.*?\s{{ webserver_hostname }} {{ webserver_hostname_alias }} adminer.{{ webserver_hostname }} xhprof.{{ webserver_hostname }} logs.{{ webserver_hostname }}'
    delegate_to: 127.0.0.1
    when: hosts_file_update is defined and hosts_file_update == "y"
    sudo: true

  - name: local actions | add reference of host to local hosts file
    lineinfile:
        dest='{{ hosts_file_location }}'
        state=present
        line='{{ local_ip_address }} {{ webserver_hostname }} {{ webserver_hostname_alias }} adminer.{{ webserver_hostname }} xhprof.{{ webserver_hostname }} logs.{{ webserver_hostname }}'
    delegate_to: 127.0.0.1
    when: hosts_file_update is defined and hosts_file_update == "y"
    sudo: true

  # SSH identities

  - name: local actions | establish current username on host machine
    command: whoami
    register: host_user
    delegate_to: 127.0.0.1

  - name: local actions | check that ~/.ssh/config exists on host machine
    stat: path=/Users/{{ host_user.stdout }}/.ssh/config
    register: ssh_config_file
    when: use_host_id != "n"
    delegate_to: 127.0.0.1
    failed_when: ssh_config_file.stat.exists == false

  # @TODO: Add further test: now that we know that ~/.ssh/config exists on the host, check to see if the string "ForwardAgent yes" appears in it.
  # Still not bullet proof, but it's *more* bullet proof ;)

  - name: local actions | add default identities from host to guest
    local_action: command ssh-add
    when: use_host_id == "y" and ssh_config_file.stat.exists

  - name: local actions | add custom identity from host to guest
    local_action: command ssh-add {{ use_host_id }}
    when: use_host_id != "y" and use_host_id != "n" and ssh_config_file.stat.exists
